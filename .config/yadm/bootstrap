#!/usr/bin/env bash
# ============================================================================
# âš™ï¸ YADM Bootstrap Script
# ============================================================================
# This script bootstraps the user's environment by installing necessary
# tools and configurations using Homebrew and other utilities.
# It is intended to be run as part of the YADM dotfiles management system.
# ============================================================================

set -euo pipefail

# ============================================================================
# COLORS
# ============================================================================

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly MAGENTA='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly BOLD='\033[1m'
readonly RESET='\033[0m'

# ============================================================================
# GLOBALS
# ============================================================================

readonly LOG_FILE="$HOME/.config/yadm/bootstrap.log"
readonly TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

OS=""
ARCH=""
IS_WSL=false
K3SUP_TLS_SAN="127.0.0.1"
K3S_SETUP_STATUS="not_available"

# ============================================================================
# HELPERS
# ============================================================================

log() { echo "[${TIMESTAMP}] $1" >> "$LOG_FILE"; }

print_header() {
    echo -e "\n${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}${CYAN}$1${RESET}"
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}\n"
    log "=== $1 ==="
}

print_success() { echo -e "${GREEN}âœ… $1${RESET}"; log "SUCCESS: $1"; }
print_info()    { echo -e "${BLUE}â„¹ï¸  $1${RESET}"; log "INFO: $1"; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${RESET}"; log "WARNING: $1"; }
print_error()   { echo -e "${RED}âŒ $1${RESET}"; log "ERROR: $1"; }
print_step()    { echo -e "${MAGENTA}ðŸ”§ $1${RESET}"; log "STEP: $1"; }

prompt_user() {
    local prompt_message="$1"
    local default_response="${2:-N}"

    local response
    read -rp "$(echo -e "${CYAN}${prompt_message} (Y/N) [Default: $default_response]: ${RESET}")" response
    echo "${response:-$default_response}"
}

cleanup() {
    local code=$?
    if [ $code -ne 0 ]; then
        print_error "Bootstrap failed with exit code $code"
        print_info "Check log: $LOG_FILE"
    fi
}
trap cleanup EXIT

show_completion_summary() {
    print_header "ðŸŽ‰ Bootstrap Completed Successfully"

    echo -e "${GREEN}All tasks finished without critical errors.${RESET}"
    echo -e ""

    # Kubernetes status summary
    if [ "${K3S_SETUP_STATUS:-}" = "installed" ]; then
        echo -e "${CYAN}â˜¸ï¸  Kubernetes cluster:${RESET}"
        echo -e "  ${GREEN}âœ“${RESET} Local k3s cluster is ready"
        echo -e "  ${BLUE}â€¢${RESET} Use ${YELLOW}kubectl --context=local${RESET} to interact with your cluster"
        echo -e "  ${BLUE}â€¢${RESET} Or switch context: ${YELLOW}kubectx local${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "installed_pending" ]; then
        echo -e "${CYAN}â˜¸ï¸  Kubernetes cluster:${RESET}"
        echo -e "  ${YELLOW}â³${RESET} Cluster installed but readiness check pending"
        echo -e "  ${BLUE}â€¢${RESET} Try manually: ${YELLOW}kubectl --context=local get nodes${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "skipped" ]; then
        echo -e "${CYAN}â˜¸ï¸  Kubernetes cluster setup (optional):${RESET}"
        echo -e "  ${BLUE}â€¢${RESET} To install later: ${YELLOW}k3sup install --local --local-path ~/.kube/config --merge --context local${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "failed" ]; then
        echo -e "${CYAN}â˜¸ï¸  Kubernetes cluster:${RESET}"
        echo -e "  ${RED}âœ—${RESET} Cluster installation failed"
        echo -e "  ${BLUE}â€¢${RESET} Check logs: ${YELLOW}$LOG_FILE${RESET}"
        echo -e "  ${BLUE}â€¢${RESET} Try again: ${YELLOW}k3sup install --local --local-path ~/.kube/config --merge --context local${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "not_available" ]; then
        echo -e "${CYAN}â˜¸ï¸  Kubernetes cluster:${RESET}"
        echo -e "  ${BLUE}â€¢${RESET} Use Orbstack to spin up a local k8s cluster: ${YELLOW}open the app and select Kubernetes${RESET}"
    fi

    echo -e ""
    echo -e "${CYAN}ðŸ“ Next steps:${RESET}"
    echo -e "  ${BLUE}*${RESET} Restart your shell in order for all changes to take effect"
    echo -e "  ${BLUE}*${RESET} Type ${YELLOW}help${RESET} to see available commands (if aliases are configured)"

    if [ "${IS_WSL:-false}" = true ] && [ "${K3S_SETUP_STATUS:-}" != "failed" ]; then
        echo -e ""
        echo -e "${CYAN}ðŸ–¥ï¸  Interacting with the Kubernetes cluster installed inside WSL on Windows Apps (Lens, etc.):${RESET}"
        echo -e "  ${BLUE}â€¢${RESET} Create/edit Windows Kubeconfig: ${YELLOW}mnt/c/Users/%USERNAME%/.kube/config${RESET}"
        echo -e "  ${BLUE}â€¢${RESET} The cluster is accessible from Windows via WSL IP"
        echo -e "  ${BLUE}â€¢${RESET} Update the cluster's server IP to $K3SUP_TLS_SAN${RESET}"
    fi

    echo -e "\nFull log available at: ${CYAN}$LOG_FILE${RESET}"
}

# ============================================================================
# OS CHECK
# ============================================================================

check_os() {
    print_step "Verifying operating system..."

    OS=$(uname -s)
    ARCH=$(uname -m)

    print_info "Operating System: $OS"
    print_info "Architecture: $ARCH"

    if [[ "$OS" != "Darwin" && "$OS" != "Linux" ]]; then
        print_error "Unsupported OS: $OS"
        exit 1
    fi

    if [[ "$OS" = "Linux" ]] && grep -qi 'microsoft' /proc/version 2>/dev/null; then
        IS_WSL=true
        K3SUP_TLS_SAN=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1)
        print_info "WSL environment detected"
    fi
}

# ============================================================================
# INSTALL BREW DEPS
# ============================================================================

install_brew_deps() {
    print_step "Selecting Brewfile..."

    local brewfile

    if [ "$OS" = "Darwin" ]; then
        brewfile="$HOME/.config/yadm/Brewfile.macos"
    else
        brewfile="$HOME/.config/yadm/Brewfile.linux"
    fi

    print_info "Using Brewfile: $brewfile"

    if [[ ! -f "$brewfile" ]]; then
        print_error "Brewfile not found!"
        exit 1
    fi

    print_info "Installing Brewfile packagesâ€¦"
    if brew bundle --file="$brewfile" --no-upgrade 2>&1 | tee -a "$LOG_FILE"; then
        print_success "Brewfile packages installed"
    else
        print_warning "Some Brew packages failed"
    fi
}

# ============================================================================
# ZSH SETUP
# ============================================================================

setup_zsh() {
    print_step "Configuring zsh shellâ€¦"

    local current=$(basename "$SHELL" || echo "unknown")
    print_info "Current shell: $current"

    if [[ "$current" != "zsh" ]]; then
        print_warning "zsh is not the default shell. Attempting to change default shell..."

        local zsh_path
        zsh_path=$(command -v zsh)

        print_info "zsh path: $zsh_path"

        if ! grep -q "^${zsh_path}$" /etc/shells 2>/dev/null; then
            print_warning "Adding zsh to /etc/shells"
            echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
        fi

        print_info "Changing default shellâ€¦"
        if [ "$OS" = "Darwin" ]; then
            if chsh -s "$ZSH_PATH"; then
                print_success "Default shell changed to zsh"
                print_warning "Please log out and log back in for the shell change to take effect"
            else
                print_error "Failed to change default shell to zsh via usermod"
                print_error "Please run manually: chsh -s $ZSH_PATH"
                exit 1
            fi
        else
            if sudo usermod -s "$ZSH_PATH" "$USER" 2>/dev/null; then
                print_success "Default shell changed to zsh via usermod"
                print_warning "Please log out and log back in for the shell change to take effect"
            else
                print_error "Failed to change default shell to zsh via usermod"
                exit 1
            fi
        fi
    else
        print_success "zsh is already default"
    fi

    if [[ ! -f "$HOME/.zshrc" ]]; then
        print_error "~/.zshrc not found â€” is your dotfiles setup incomplete?"
        exit 1
    fi

    print_success "zsh config OK"
}

# ============================================================================
# KUBE CONFIG
# ============================================================================

kube_config() {
    [[ "$OS" = "Darwin" ]] && return 0

    print_step "Setting up Kubernetes configuration directoryâ€¦"

    mkdir -p "$HOME/.kube"

    local file="$HOME/.kube/config"

    if [[ -f "$file" ]]; then
        local backup="$file.backup.$(date +%Y%m%d-%H%M%S)"
        print_info "Backing up existing kubeconfig â†’ $backup"
        cp "$file" "$backup"
    else
        print_info "Creating default kubeconfig"
        /bin/cat > "$file" << 'EOF'
apiVersion: v1
kind: Config
clusters: []
contexts: []
current-context: ""
preferences: {}
users: []
EOF
        chmod 600 "$file"
    fi

    print_success "Kube config initialized"
}

# ============================================================================
# INSTALL K3S
# ============================================================================

install_k3s() {
    [[ "$OS" = "Darwin" ]] && return 0
    command -v k3sup >/dev/null || return 0

    print_step "Local Kubernetes cluster setup (optional)"

    if [[ $(prompt_user "Install local k3s cluster?" "Y") =~ ^[Yy]$ ]]; then
        print_info "Installing k3sâ€¦"

        if k3sup install \
            --local \
            --local-path "$HOME/.kube/config" \
            --merge \
            --context "local" \
            --k3s-extra-args "--disable traefik --disable metrics-server" \
            --tls-san "$K3SUP_TLS_SAN"; then

            print_success "k3s installed"

            print_info "Checking cluster readinessâ€¦"

            if k3sup ready --context="local" --kubeconfig="$HOME/.kube/config"; then
                print_success "Cluster ready!"
                K3S_SETUP_STATUS="installed"
            else
                print_warning "Cluster readiness timed out"
                K3S_SETUP_STATUS="installed_pending"
            fi
        else
            print_error "k3s install failed"
            K3S_SETUP_STATUS="failed"
        fi
    else
        print_info "Skipping k3s installation"
        K3S_SETUP_STATUS="skipped"
    fi
}

# ============================================================================
# SECRET DECRYPTION
# ============================================================================

decrypt_secrets() {
    if [[ $(prompt_user "Decrypt yadm secrets?" "Y") =~ ^[Yy]$ ]]; then
        print_step "Decrypting secretsâ€¦"

        if yadm decrypt; then
            print_success "Secrets decrypted"

            local repo=$(yadm remote get-url origin 2>/dev/null || echo "")

            if [[ "$repo" =~ ^https:// ]]; then
                if [[ $(prompt_user "Switch yadm to SSH remote?" "Y") =~ ^[Yy]$ ]]; then
                    local suggested=$(echo "$repo" | sed -E 's|https://([^/]+)/|git@\1:|')
                    print_info "Suggested SSH URL: $suggested"
                    read -rp "$(echo -e "${CYAN}Enter your SSH URL (or press Enter to use suggested): ${RESET}")" ssh
                    ssh="${ssh:-$suggested}"

                    if [[ -n "$ssh" ]]; then
                        if yadm remote set-url origin "$ssh"; then
                            print_success "yadm remote switched to SSH: $ssh"
                        else
                            print_error "Failed to switch remote to SSH"
                        fi
                    else
                        print_warning "No SSH URL provided. Skipping remote switch."
                    fi
                fi
            else
                print_info "Repository already uses SSH or non-HTTPS protocol. No remote switch needed."
            fi
        else
            print_warning "Secrets decryption skipped. You can decrypt later with: yadm decrypt"
        fi
    else
        print_info "Skipping secret decryption"
    fi
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    print_header "ðŸš€ YADM Bootstrap Starting"

    echo "=== Bootstrap started at ${TIMESTAMP} ===" > "$LOG_FILE"

    check_os
    install_brew_deps
    setup_zsh
    kube_config
    install_k3s
    decrypt_secrets

    show_completion_summary
}

main "$@"
