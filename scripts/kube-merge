#!/usr/bin/env bash
# ============================================================================
# Kubernetes Config Merger
# ============================================================================
# Merges multiple kubeconfig files into a single ~/.kube/config file
# Usage: kube-merge
# ============================================================================

set -euo pipefail

# Color definitions
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly RED='\033[0;31m'
readonly RESET='\033[0m'

# Dynamically find all config files (excluding the main merged config)
readonly KUBE_DIR="$HOME/.kube"
readonly MERGED_CONFIG="$KUBE_DIR/config"
readonly BACKUP_CONFIG="$KUBE_DIR/config.backup"

# Find all config.* files, excluding config itself and backup files
mapfile -t CONFIG_FILES < <(find "$KUBE_DIR" -maxdepth 1 -type f -name 'config.*' ! -name '*.backup' | sort)

echo -e "${BLUE}üîÑ Merging Kubernetes configs...${RESET}\n"

# Check if kubectl is available
if ! command -v kubectl >/dev/null 2>&1; then
    echo -e "${RED}‚ùå kubectl not found. Please install kubectl first.${RESET}"
    exit 1
fi

# Build list of existing config files
KUBE_CONFIGS=""
FOUND_CONFIGS=()

for config_file in "${CONFIG_FILES[@]}"; do
    if [ -f "$config_file" ]; then
        if [ -z "$KUBE_CONFIGS" ]; then
            KUBE_CONFIGS="$config_file"
        else
            KUBE_CONFIGS="$KUBE_CONFIGS:$config_file"
        fi
        FOUND_CONFIGS+=("$config_file")
        echo -e "${GREEN}‚úì${RESET} Found: $config_file"
    else
        echo -e "${YELLOW}‚äò${RESET} Not found: $config_file"
    fi
done

if [ -z "$KUBE_CONFIGS" ]; then
    echo -e "\n${YELLOW}‚ö†Ô∏è  No kubeconfig files found to merge.${RESET}"
    echo -e "Looking for files matching: $KUBE_DIR/config.*"
    echo -e "Create config files like: config.local, config.dev, config.prod"
    exit 1
fi

# Backup existing config if it exists
if [ -f "$MERGED_CONFIG" ]; then
    echo -e "\n${BLUE}üì¶ Backing up existing config...${RESET}"
    cp "$MERGED_CONFIG" "$BACKUP_CONFIG"
    echo -e "${GREEN}‚úì${RESET} Backup created: $BACKUP_CONFIG"
fi

# Merge configs
echo -e "\n${BLUE}üîÄ Merging ${#FOUND_CONFIGS[@]} config file(s)...${RESET}"
if KUBECONFIG="$KUBE_CONFIGS" kubectl config view --flatten > "$MERGED_CONFIG"; then
    echo -e "${GREEN}‚úÖ Successfully merged configs into: $MERGED_CONFIG${RESET}\n"
    
    # Show available contexts
    echo -e "${BLUE}üìã Available contexts:${RESET}"
    kubectl config get-contexts --no-headers | awk '{print "  ‚Ä¢ " $2}'
    
    # Show current context
    CURRENT_CONTEXT=$(kubectl config current-context 2>/dev/null || echo "none")
    echo -e "\n${BLUE}üéØ Current context:${RESET} ${GREEN}$CURRENT_CONTEXT${RESET}"
else
    echo -e "${RED}‚ùå Failed to merge configs${RESET}"
    
    # Restore backup if merge failed
    if [ -f "$BACKUP_CONFIG" ]; then
        echo -e "${YELLOW}‚Ü©Ô∏è  Restoring backup...${RESET}"
        mv "$BACKUP_CONFIG" "$MERGED_CONFIG"
    fi
    exit 1
fi

echo ""
